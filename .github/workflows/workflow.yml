name: Trivy Scan

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  trivy-scan:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find and scan Docker images with Trivy
        id: trivy
        run: |
          set -e
          mkdir -p trivy-reports
          failed=0

          # Find all images declared in the repo (adjust grep path as needed)
          images=$(grep -rhoP 'image:\s*\K\S+' ../stack/stack.yml | sort -u)

          for img in $images; do
            echo "🔍 Processing $img ..."
            
            # Check if the image exists locally
            if docker image inspect "$img" > /dev/null 2>&1; then
              echo "✅ Found locally: $img"
            else
              echo "📥 Pulling missing image: $img"
              docker pull "$img"
            fi

            # Run Trivy scan
            safe_name=$(echo "$img" | tr '/:' '__')
            trivy image --severity HIGH,CRITICAL --exit-code 1 \
              --format table --output trivy-reports/${safe_name}.txt "$img" || failed=1
          done

          exit $failed

      - name: Upload scan reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: trivy-reports/

      - name: Combine reports into single file
        if: always()
        run: |
          echo "## 🛡️ Trivy Scan Results" > combined-report.md
          for f in trivy-reports/*.txt; do
            echo -e "\n---\n### Report: $(basename $f)" >> combined-report.md
            cat "$f" >> combined-report.md
          done

      - name: Create or update Trivy scan issue
        if: always()
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "🚨 Trivy Scan Results"
          content-filepath: combined-report.md
          labels: security, vulnerability

