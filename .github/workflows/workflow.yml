name: Trivy Scan

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  trivy-scan:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy scan on all local Docker images
        id: trivy
        run: |
          set -e
          mkdir -p trivy-reports
          failed=0
          for img in $(docker images --format "{{.Repository}}:{{.Tag}}"); do
            echo "üîç Scanning $img ..."
            trivy image --severity HIGH,CRITICAL --exit-code 1 --format table --output trivy-reports/${img//[:\/]/_}.txt "$img" || failed=1
          done
          exit $failed

      - name: Upload scan reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: trivy-reports/

      - name: Create or update Trivy scan issue
        if: always()
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "üö® Trivy Scan Results"
          content-filepath: trivy-reports/$(ls trivy-reports | head -n 1)
          labels: security, vulnerability

