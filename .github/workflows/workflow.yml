name: Trivy Scan

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  trivy-scan:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find and scan Docker images with Trivy
        id: trivy
        run: |
          set -e
          mkdir -p trivy-reports
          failed=0

          # Find all images declared in the repo 
          images=$(grep -rhoP 'image:\s*\K\S+' ../../../stack/stack.yml | sort -u)

          for img in $images; do
            echo "ðŸ” Processing $img ..."
            
            # Check if the image exists locally
            if docker image inspect "$img" > /dev/null 2>&1; then
              echo "âœ… Found locally: $img"
            else
              echo "ðŸ“¥ Pulling missing image: $img"
              docker pull "$img"
            fi

            # Run Trivy scan
            safe_name=$(echo "$img" | tr '/:' '__')
            trivy image --severity HIGH,CRITICAL --exit-code 1 \
              --format table --output trivy-reports/${safe_name}.txt "$img" 
          done

          # Use find to recursively process all files
          find . -type f -exec sh -c '
            for file do
              # Use awk to check the pattern in each file
              awk "
                /^==========$/ {
                  getline next_line
                  if (next_line !~ /Total: 0/) {
                    print \"Found issue in: \" FILENAME
                    exit 1
                  }
                }
              " "$file" >/dev/null 2>&1
    
          # If awk exited with status 1, set failed flag
          if [ $? -eq 1 ]; then
          failed=1
          fi
           done
          ' sh {} +

          # Export the failed variable to environment
          export failed
          exit $failed

      - name: Upload scan reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: trivy-reports/

      - name: Combine reports into single file
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ Trivy Scan Results" > combined-report.md
          for f in trivy-reports/*.txt; do
            echo -e "\n---\n### Report: $(basename $f)" >> combined-report.md
            cat "$f" >> combined-report.md
          done

      - name: Create or update Trivy scan issue
        if: always()
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "ðŸš¨ Trivy Scan Results"
          content-filepath: combined-report.md
          labels: security, vulnerability

