http {
    upstream dashboard_cluster {
        least_conn;
        server wazuh1.dashboard:443;
        server wazuh2.dashboard:443;
    }

    server {
        listen 443 ssl http2;
        server_name wazuh.hrfess.xyz;

        # --- PUBLIC CERTIFICATE FOR EXTERNAL CLIENTS ---
        ssl_certificate /etc/letsencrypt/live/wazuh.hrfess.xyz/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/wazuh.hrfess.xyz/privkey.pem;

        location / {
            # --- PROXY PASSES HTTPS TO BACKEND ---
            proxy_pass https://dashboard_cluster;

            # --- TRUST THE INTERNAL CA OR SELF-SIGNED CERT ---
            proxy_ssl_verify on; # Verify the backend's certificate
            proxy_ssl_trusted_certificate /etc/nginx/ssl/root-ca.pem; # Path to your Internal CA's public cert
            proxy_ssl_verify_depth 2;
            proxy_ssl_name $proxy_host; # Or use a specific SNI: proxy_ssl_name internal-dash.example.com;

            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
